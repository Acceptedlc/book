# CRM重构白皮书


### 前世今生

不知不觉中CRM系统已经快要1岁了。在这几个月的时间里，整个团队完成了从0到1，从1到N的过程，这是值得肯定的地方。

但是，正如同中国的经济一样，在经历过高速的发展期后，必然需要停顿那么一下，来进行产业结构的调整，我们的系统也是一样的。目前系统的库扩展性跟可维护性都已经亮起了红灯，下面我将从几个不同的角度总结一下现在系统的主要矛盾。

* 需求管理方面
	*  首先，对于需求的讨论不够。合理的需求实现了，不合理的需求也实现了。
	*  第二，某些需求实现的方法不正确。使用方提供的需求，是非常感性的。我们需要对这些需求进行抽象与归纳，然后才是具体的实现，这一步是缺失的。
	*  第三，需求无文档。这直接导致无法进行系统的分析。

* 技术方面
	* __系统结构设计不合理，充分的展现了低内聚，高耦合的特点。__（比如，clue的create操作，散落在每一个业务逻辑中，当需要添加默认数值的时候，需要在整个项目中寻找所有的sql操作，进行修改。再比如，在clue的创建方法中还有创建操作日志的动作。还有，由于缺乏统一的设计跟管理，系统的中存在大量的功能相同的代码等等）
	* __采用技术老旧。__（比如：使用的bodyParser无法自动完成序列化与反序列化。这种公共的东西还需要出现在业务代码当中等）
	* __api设计混乱。__ （比如：clue的put操作，出现了各种不同的api。前端还需要给每个api传递不同格式的参数）
	* __权限系统接近崩溃。__ 原有的权限的设计依然不能满足现有的也无需求，


### 逐步迁移方案

![CRM逐步迁移方案示意图](http://7xovlo.com1.z0.glb.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-09-23%20%E4%B8%8B%E5%8D%885.46.26.png)


### 权限模型

* __对于权限，引入组的概念__
	* __系统自动生成组__：创建用户的同时创建该用户的组，这个组里有这个用户跟他在行政体系中的上级。这样我们称这个用户跟他的领导加入了这个用户的组。也意味着，这个用户跟他的领导拥有了这个组。
	* __手动创建组__：有管理员创建组，并把制定用户放入到组内。例如：管理员创建新中关组，并把新中关的员工添加到改组中。
* __数据修改__: 给每个数据表增加r,w两列。
	* r：可以读这条数据的组id
	* w：可以写这条数据的组id
* __访问控制__：
	* 首先获得当前用户拥有的所有组，我们称为集合A。
	* 待访问的数据的r，称为集合R。
	* 待访问的数据的w，称为集合W。
	* 只能读取 A ∩ R != Ø 的数据。
	* 只能修改 A ∩ W != Ø 的数据。
* __读写组的修改(先按照数据表的角度归纳)：__
	* 针对每一个数据表，整理一种规律。例如：学生表的r，w为creatorId这个用户的组。

### 需求整理与批判

#### 市场活动

*  __创建市场活动__
	* 活动主题为不可重复字段
	* 活动日期，预算部门负责人，活动主题，信息来源，省，市为必填字段
	* 保存按钮的市场活动还可以修改。
	* 保存并提交的市场活动用户不能再次编辑其内容了，并且需要记录市场活动日志。
* __市场活动列表__
	* 用户只能查看自己跟自己下级的市场活动
* __审批市场活动__
	*  从市场活动列表页面，点击查看，然后进入详情页，点击批准跟拒绝（用户只能审批自己跟下级的市场活动）
	*  被拒绝的市场活动，将会解锁，可以再次进行编辑跟提交
	*  无论批准还是拒绝都需要记录市场活动日志
* __总结市场活动__
	* 跟审批一样，只能总结自己的跟下级的。具体就是填写一个表单，保存到数据库。
* __市场活动详情__
	* 这个页面可以查看市场活动的所有数据
	* 下方可以看到，与市场活动有关系的市场活动明细，工单，商机，合同，市场活动的历史记录
		* 李超：不清楚这个功能的作用，个人感觉意义不大。但是，对于权限系统造成了很大的冲击，造成了安全漏洞。希望砍掉。
		
* __市场活动活动结果导入__
	* 	选择市场活动（只能选择自己跟自己下级的）
	*  选择csv
	*  点击导入
	*  对于每一条导入数据，如果没有学生就创建学生，如果没有未关闭状态的工单，商机就创建一个工单，责任人就是导入的操作人，最后创建市场活动明细
* __市场活动活动结果列表__
	*  只能查看自己跟自己下级的市场活动明细
* __市场活动活动结果创建__
	* 选择市场活动（只能是自己跟自己下级的）
	* 填写信息，具体创建规则见导入市场活动结果

### 市场部商机

* __分配商机__
	* 用户可以分配的商机只有自己的跟自己的下级
	* 用户可以看到所有的机构列表
	* 选择商机跟机构（商机多选，机构多选）
* __分配追踪__ 
	* 用户需要看到所有商机提供人是操作人员及其下级的商机
		* 李超：这个功能是用来解决两个问题的。
			1. 市场人员的到一些非常精准的商机，他需要提醒销售尽快跟进。对于这个问题，可以在生成商机的时候，自动把星级提高，然后由系统去提醒销售人员尽快跟进。
			2. 市场人员检查销售的工作是否作假。可以建立一个模型，通过统计学的方法对于销售进行的工作进行检测。
			3. 综上所述，这个功能可以在系统更加完善的前提下砍掉。从而，确保权限系统的统一。

### 商机管理

* __分配商机__
	* 用户可以获得本机构所有责任人为空，状态为未分配的商机的数量
	* 用户可以获得所有本机构的员工的信息。
	* 用户将一定数量的商机分配给用户
* __新商机列表，跟进商机列表__ 
	* 这两个页面可以查看的商机到商机是自己跟下级。只是筛选的条件不同。
		* 李超：完全可以合并成一个列表页。用户可以通过状态进行筛选。而且现在筛选条件还是可以保存下来的。
* __商机分配__ 
	* 将自己跟下级的商机分配给机构内的人员
	* 商机可以多选，用户只能单选
* __商机创建__  
	* 首先输入电话号码，点击检索。如果不存在这个商机则用户填写表单创建商机。如果存在这个商机或者工单直接跳转到详情页。
		* 李超：建议取消跳转，告诉用户商机已经存在即可。否则会在成安全漏洞。
* __商机派单__  
	* 用户选择商机（自己的跟自己下级的）选择机构。将选中的商机派单到选中的机构中
* __商机派单__   
	* 用户可以
	
	
		
	



	



